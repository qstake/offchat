name: iOS IPA Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build web app
      run: npm run build

    - name: Install Capacitor CLI and iOS platform
      run: |
        npm install @capacitor/core @capacitor/cli @capacitor/ios @capacitor-community/bluetooth-le
        npx cap init Offchat app.offchat.messenger --web-dir dist/public || true

    - name: Create Capacitor config
      run: |
        cat > capacitor.config.ts << 'EOF'
        import type { CapacitorConfig } from '@capacitor/cli';
        const config: CapacitorConfig = {
          appId: 'app.offchat.messenger',
          appName: 'Offchat',
          webDir: 'dist/public',
          server: {
            iosScheme: 'https'
          },
          plugins: {
            BluetoothLe: {
              displayStrings: {
                scanning: 'Searching for Offchat users...',
                cancel: 'Cancel',
                availableDevices: 'Nearby Offchat Users',
                noDeviceFound: 'No Offchat users found nearby'
              }
            }
          }
        };
        export default config;
        EOF

    - name: Add iOS platform (without pod install)
      env:
        CAPACITOR_SKIP_POD_INSTALL: 'true'
      run: |
        npx cap add ios || true
        echo "iOS native project created"

    - name: Fix iOS deployment target in Podfile
      run: |
        PODFILE="ios/App/Podfile"
        if [ -f "$PODFILE" ]; then
          sed -i '' "s/platform :ios, '.*'/platform :ios, '16.0'/g" "$PODFILE"
          echo "Podfile updated to iOS 16.0:"
          cat "$PODFILE"
        else
          echo "ERROR: Podfile not found!"
          exit 1
        fi

    - name: Fix iOS deployment target in Xcode project
      run: |
        PROJECT="ios/App/App.xcodeproj/project.pbxproj"
        if [ -f "$PROJECT" ]; then
          sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9]*\.[0-9]*/IPHONEOS_DEPLOYMENT_TARGET = 16.0/g' "$PROJECT"
          echo "Xcode project deployment target set to 16.0"
        fi

    - name: Install CocoaPods dependencies
      working-directory: ios/App
      run: pod install --repo-update

    - name: Add Bluetooth usage descriptions to Info.plist
      run: |
        PLIST="ios/App/App/Info.plist"
        if [ -f "$PLIST" ]; then
          /usr/libexec/PlistBuddy -c "Add :NSBluetoothAlwaysUsageDescription string 'Offchat uses Bluetooth to send messages to nearby users without internet'" "$PLIST" || true
          /usr/libexec/PlistBuddy -c "Add :NSBluetoothPeripheralUsageDescription string 'Offchat uses Bluetooth to communicate with nearby devices'" "$PLIST" || true
          /usr/libexec/PlistBuddy -c "Add :NSLocalNetworkUsageDescription string 'Offchat uses local network to discover nearby users'" "$PLIST" || true
          echo "Bluetooth permissions added to Info.plist"
        fi

    - name: Set app icon
      run: |
        LOGO="client/public/applogo.png"
        if [ -f "$LOGO" ]; then
          ICONSET="ios/App/App/Assets.xcassets/AppIcon.appiconset"
          if [ -d "$ICONSET" ]; then
            cp "$LOGO" "$ICONSET/AppIcon-20x20@1x.png"
            cp "$LOGO" "$ICONSET/AppIcon-20x20@2x.png"
            cp "$LOGO" "$ICONSET/AppIcon-20x20@3x.png"
            cp "$LOGO" "$ICONSET/AppIcon-29x29@1x.png"
            cp "$LOGO" "$ICONSET/AppIcon-29x29@2x.png"
            cp "$LOGO" "$ICONSET/AppIcon-29x29@3x.png"
            cp "$LOGO" "$ICONSET/AppIcon-40x40@1x.png"
            cp "$LOGO" "$ICONSET/AppIcon-40x40@2x.png"
            cp "$LOGO" "$ICONSET/AppIcon-40x40@3x.png"
            cp "$LOGO" "$ICONSET/AppIcon-60x60@2x.png"
            cp "$LOGO" "$ICONSET/AppIcon-60x60@3x.png"
            cp "$LOGO" "$ICONSET/AppIcon-76x76@1x.png"
            cp "$LOGO" "$ICONSET/AppIcon-76x76@2x.png"
            cp "$LOGO" "$ICONSET/AppIcon-83.5x83.5@2x.png"
            cp "$LOGO" "$ICONSET/AppIcon-512@2x.png" 2>/dev/null || true
            echo "App icon updated from applogo.png"
          fi
        else
          echo "applogo.png not found, using default icon"
        fi

    - name: Copy web assets to iOS
      run: npx cap copy ios

    - name: Update iOS plugins
      run: |
        npx cap update ios || true
        cd ios/App && pod install --repo-update

    - name: Install Apple certificate and provisioning profile
      env:
        P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
        P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
      run: |
        P12_PATH=$RUNNER_TEMP/distribution.p12
        PP_PATH=$RUNNER_TEMP/offchat.mobileprovision
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KEYCHAIN_PASSWORD="temporary-keychain-password"

        echo "$P12_BASE64" | base64 --decode > "$P12_PATH"
        echo "$PROVISION_PROFILE_BASE64" | base64 --decode > "$PP_PATH"

        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security default-keychain -s "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

        security import "$P12_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
        security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security list-keychain -d user -s "$KEYCHAIN_PATH"

        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        PP_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin <<< "$(security cms -D -i "$PP_PATH")")
        PP_NAME=$(/usr/libexec/PlistBuddy -c "Print :Name" /dev/stdin <<< "$(security cms -D -i "$PP_PATH")")
        cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/"$PP_UUID".mobileprovision

        echo "PP_UUID=$PP_UUID" >> $GITHUB_ENV
        echo "PP_NAME=$PP_NAME" >> $GITHUB_ENV
        echo "Certificate and provisioning profile installed (UUID: $PP_UUID, Name: $PP_NAME)"

    - name: Configure signing via pbxproj injection
      run: |
        PROJECT="ios/App/App.xcodeproj/project.pbxproj"
        
        # Use Ruby to properly inject signing settings into the App target build configs
        ruby << 'RUBY'
        content = File.read("ios/App/App.xcodeproj/project.pbxproj")
        
        team_id = ENV['IOS_TEAM_ID'] || '${{ secrets.IOS_TEAM_ID }}'
        pp_name = ENV['PP_NAME'] || ''
        
        # Replace all buildSettings blocks that contain INFOPLIST_FILE (only App target has this)
        # This ensures we only modify App target, not Pods
        content.gsub!(/INFOPLIST_FILE = "App\/Info\.plist";/) do |match|
          "#{match}\n\t\t\t\tCODE_SIGN_IDENTITY = \"Apple Distribution\";\n\t\t\t\tCODE_SIGN_STYLE = Manual;\n\t\t\t\tDEVELOPMENT_TEAM = \"${{ secrets.IOS_TEAM_ID }}\";\n\t\t\t\tPROVISIONING_PROFILE_SPECIFIER = \"#{pp_name}\";"
        end
        
        File.write("ios/App/App.xcodeproj/project.pbxproj", content)
        puts "Signing injected into App target build settings"
        RUBY
        
        echo "Signing configured for App target"

    - name: Build iOS archive
      run: |
        xcodebuild -workspace ios/App/App.xcworkspace \
          -scheme App \
          -sdk iphoneos \
          -configuration Release \
          -archivePath $RUNNER_TEMP/Offchat.xcarchive \
          archive \
          -destination "generic/platform=iOS" \
          -allowProvisioningUpdates \
          ONLY_ACTIVE_ARCH=NO

    - name: Export IPA
      run: |
        cat > $RUNNER_TEMP/ExportOptions.plist << PLIST
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key>
          <string>ad-hoc</string>
          <key>teamID</key>
          <string>${{ secrets.IOS_TEAM_ID }}</string>
          <key>provisioningProfiles</key>
          <dict>
            <key>app.offchat.messenger</key>
            <string>$PP_NAME</string>
          </dict>
          <key>signingStyle</key>
          <string>manual</string>
          <key>compileBitcode</key>
          <false/>
          <key>stripSwiftSymbols</key>
          <true/>
        </dict>
        </plist>
        PLIST

        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/Offchat.xcarchive \
          -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist \
          -exportPath $RUNNER_TEMP/export \
          -allowProvisioningUpdates

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: offchat-ios-ipa
        path: ${{ runner.temp }}/export/*.ipa
        retention-days: 30

    - name: Clean up keychain
      if: always()
      run: |
        security default-keychain -s login.keychain-db 2>/dev/null || true
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true
