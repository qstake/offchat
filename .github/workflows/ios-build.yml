name: iOS IPA Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build web app
      run: npm run build

    - name: Install Capacitor
      run: npm install @capacitor/core @capacitor/cli @capacitor/ios @capacitor-community/bluetooth-le

    - name: Create Capacitor config
      run: |
        rm -f capacitor.config.ts capacitor.config.json
        cat > capacitor.config.json << 'CAPEOF'
        {
          "appId": "app.offchat.messenger",
          "appName": "Offchat",
          "webDir": "dist/public",
          "server": { "iosScheme": "https" },
          "plugins": {
            "BluetoothLe": {
              "displayStrings": {
                "scanning": "Searching for Offchat users...",
                "cancel": "Cancel",
                "availableDevices": "Nearby Offchat Users",
                "noDeviceFound": "No Offchat users found nearby"
              }
            }
          }
        }
        CAPEOF

    - name: Add iOS platform
      run: npx cap add ios 2>&1 || true

    - name: Fix deployment target and patch Podfile
      run: |
        # 1. Fix deployment target in Podfile (keep Capacitor's auto-generated pods)
        sed -i '' "s/platform :ios, '.*'/platform :ios, '16.0'/g" ios/App/Podfile

        # 2. Add post_install hook to disable code signing for Pods
        # Check if post_install already exists
        if grep -q "post_install" ios/App/Podfile; then
          echo "post_install already exists in Podfile, patching it"
          # Replace existing post_install block
          python3 << 'PYEOF'
        import re
        with open("ios/App/Podfile", "r") as f:
            content = f.read()
        # Remove existing post_install block
        content = re.sub(r'post_install do \|installer\|.*?end\n', '', content, flags=re.DOTALL)
        # Add new post_install
        content += """
post_install do |installer|
  assertDeploymentTarget(installer)
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
      config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '16.0'
    end
  end
end
"""
        with open("ios/App/Podfile", "w") as f:
            f.write(content)
        PYEOF
        else
          echo "Adding post_install hook to Podfile"
          cat >> ios/App/Podfile << 'HOOKEOF'

post_install do |installer|
  assertDeploymentTarget(installer)
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
      config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '16.0'
    end
  end
end
HOOKEOF
        fi

        # 3. Fix deployment target in Xcode project
        sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9]*\.[0-9]*/IPHONEOS_DEPLOYMENT_TARGET = 16.0/g' ios/App/App.xcodeproj/project.pbxproj

        echo "=== Final Podfile ==="
        cat ios/App/Podfile
        echo "=== Deployment target fixed to 16.0 ==="

    - name: Install CocoaPods
      working-directory: ios/App
      run: pod install --repo-update

    - name: Copy web assets
      run: npx cap copy ios

    - name: Add Bluetooth permissions
      run: |
        PLIST="ios/App/App/Info.plist"
        /usr/libexec/PlistBuddy -c "Add :NSBluetoothAlwaysUsageDescription string 'Offchat uses Bluetooth to send messages to nearby users without internet'" "$PLIST" 2>/dev/null || true
        /usr/libexec/PlistBuddy -c "Add :NSBluetoothPeripheralUsageDescription string 'Offchat uses Bluetooth to communicate with nearby devices'" "$PLIST" 2>/dev/null || true
        /usr/libexec/PlistBuddy -c "Add :NSLocalNetworkUsageDescription string 'Offchat uses local network to discover nearby users'" "$PLIST" 2>/dev/null || true

    - name: Set app icon
      run: |
        LOGO="client/public/applogo.png"
        if [ -f "$LOGO" ]; then
          ICONSET="ios/App/App/Assets.xcassets/AppIcon.appiconset"
          if [ -d "$ICONSET" ]; then
            for SIZE in AppIcon-20x20@1x AppIcon-20x20@2x AppIcon-20x20@3x AppIcon-29x29@1x AppIcon-29x29@2x AppIcon-29x29@3x AppIcon-40x40@1x AppIcon-40x40@2x AppIcon-40x40@3x AppIcon-60x60@2x AppIcon-60x60@3x AppIcon-76x76@1x AppIcon-76x76@2x AppIcon-83.5x83.5@2x; do
              cp "$LOGO" "$ICONSET/${SIZE}.png"
            done
            cp "$LOGO" "$ICONSET/AppIcon-512@2x.png" 2>/dev/null || true
          fi
        fi

    - name: Install certificate and provisioning profile
      env:
        P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
        P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        PP_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
      run: |
        CERT_PATH=$RUNNER_TEMP/certificate.p12
        PP_PATH=$RUNNER_TEMP/profile.mobileprovision
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KC_PASSWORD="actions-keychain-password"

        echo -n "$P12_BASE64" | base64 --decode -o "$CERT_PATH"
        echo -n "$PP_BASE64" | base64 --decode -o "$PP_PATH"

        security create-keychain -p "$KC_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KC_PASSWORD" "$KEYCHAIN_PATH"
        security import "$CERT_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
        security set-key-partition-list -S apple-tool:,apple: -k "$KC_PASSWORD" "$KEYCHAIN_PATH"
        security list-keychain -d user -s "$KEYCHAIN_PATH"

        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

        # Extract UUID and Name using PlistBuddy (most reliable method)
        PLIST_XML=$(security cms -D -i "$PP_PATH")
        PP_UUID=$(echo "$PLIST_XML" | /usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin)
        PP_NAME=$(echo "$PLIST_XML" | /usr/libexec/PlistBuddy -c "Print :Name" /dev/stdin)

        cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/"${PP_UUID}.mobileprovision"

        echo "PP_UUID=$PP_UUID" >> $GITHUB_ENV
        echo "PP_NAME=$PP_NAME" >> $GITHUB_ENV

        echo "Installed certificate and provisioning profile:"
        echo "  Profile Name: $PP_NAME"
        echo "  Profile UUID: $PP_UUID"
        security find-identity -v -p codesigning "$KEYCHAIN_PATH"

    - name: Build iOS archive
      run: |
        xcodebuild -workspace ios/App/App.xcworkspace \
          -scheme App \
          -sdk iphoneos \
          -configuration Release \
          -archivePath $RUNNER_TEMP/Offchat.xcarchive \
          -destination "generic/platform=iOS" \
          clean archive \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGN_STYLE=Manual \
          DEVELOPMENT_TEAM="${{ secrets.IOS_TEAM_ID }}" \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          PROVISIONING_PROFILE="$PP_UUID"

    - name: Export IPA
      run: |
        cat > $RUNNER_TEMP/ExportOptions.plist << PLIST
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key>
          <string>ad-hoc</string>
          <key>teamID</key>
          <string>${{ secrets.IOS_TEAM_ID }}</string>
          <key>signingStyle</key>
          <string>manual</string>
          <key>provisioningProfiles</key>
          <dict>
            <key>app.offchat.messenger</key>
            <string>${PP_NAME}</string>
          </dict>
          <key>compileBitcode</key>
          <false/>
          <key>stripSwiftSymbols</key>
          <true/>
        </dict>
        </plist>
        PLIST

        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/Offchat.xcarchive \
          -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist \
          -exportPath $RUNNER_TEMP/export \
          -allowProvisioningUpdates

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: offchat-ios-ipa
        path: ${{ runner.temp }}/export/*.ipa
        retention-days: 30

    - name: Clean up keychain
      if: always()
      run: |
        security default-keychain -s login.keychain-db 2>/dev/null || true
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true
