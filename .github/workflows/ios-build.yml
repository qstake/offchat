name: iOS IPA Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build web app
      run: npm run build

    - name: Install Capacitor
      run: |
        npm install @capacitor/core @capacitor/cli @capacitor/ios @capacitor-community/bluetooth-le

    - name: Create Capacitor config
      run: |
        rm -f capacitor.config.ts capacitor.config.json
        cat > capacitor.config.json << 'EOF'
        {
          "appId": "app.offchat.messenger",
          "appName": "Offchat",
          "webDir": "dist/public",
          "server": {
            "iosScheme": "https"
          },
          "plugins": {
            "BluetoothLe": {
              "displayStrings": {
                "scanning": "Searching for Offchat users...",
                "cancel": "Cancel",
                "availableDevices": "Nearby Offchat Users",
                "noDeviceFound": "No Offchat users found nearby"
              }
            }
          }
        }
        EOF

    - name: Add iOS platform
      run: |
        npx cap add ios 2>&1 || true

    - name: Fix iOS deployment target
      run: |
        sed -i '' "s/platform :ios, '.*'/platform :ios, '16.0'/g" ios/App/Podfile
        sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9]*\.[0-9]*/IPHONEOS_DEPLOYMENT_TARGET = 16.0/g' ios/App/App.xcodeproj/project.pbxproj
        echo "Deployment target set to iOS 16.0"

    - name: Install CocoaPods
      working-directory: ios/App
      run: pod install --repo-update

    - name: Copy web assets
      run: npx cap copy ios

    - name: Add Bluetooth usage descriptions
      run: |
        PLIST="ios/App/App/Info.plist"
        /usr/libexec/PlistBuddy -c "Add :NSBluetoothAlwaysUsageDescription string 'Offchat uses Bluetooth to send messages to nearby users without internet'" "$PLIST" 2>/dev/null || true
        /usr/libexec/PlistBuddy -c "Add :NSBluetoothPeripheralUsageDescription string 'Offchat uses Bluetooth to communicate with nearby devices'" "$PLIST" 2>/dev/null || true
        /usr/libexec/PlistBuddy -c "Add :NSLocalNetworkUsageDescription string 'Offchat uses local network to discover nearby users'" "$PLIST" 2>/dev/null || true

    - name: Set app icon
      run: |
        LOGO="client/public/applogo.png"
        if [ -f "$LOGO" ]; then
          ICONSET="ios/App/App/Assets.xcassets/AppIcon.appiconset"
          if [ -d "$ICONSET" ]; then
            for SIZE in AppIcon-20x20@1x AppIcon-20x20@2x AppIcon-20x20@3x AppIcon-29x29@1x AppIcon-29x29@2x AppIcon-29x29@3x AppIcon-40x40@1x AppIcon-40x40@2x AppIcon-40x40@3x AppIcon-60x60@2x AppIcon-60x60@3x AppIcon-76x76@1x AppIcon-76x76@2x AppIcon-83.5x83.5@2x; do
              cp "$LOGO" "$ICONSET/${SIZE}.png"
            done
            cp "$LOGO" "$ICONSET/AppIcon-512@2x.png" 2>/dev/null || true
          fi
        fi

    - name: Install certificate and provisioning profile
      env:
        P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
        P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        PP_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
      run: |
        CERT_PATH=$RUNNER_TEMP/certificate.p12
        PP_PATH=$RUNNER_TEMP/profile.mobileprovision
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KC_PASSWORD="actions-keychain-password"

        echo -n "$P12_BASE64" | base64 --decode -o "$CERT_PATH"
        echo -n "$PP_BASE64" | base64 --decode -o "$PP_PATH"

        security create-keychain -p "$KC_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KC_PASSWORD" "$KEYCHAIN_PATH"
        security import "$CERT_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
        security set-key-partition-list -S apple-tool:,apple: -k "$KC_PASSWORD" "$KEYCHAIN_PATH"
        security list-keychain -d user -s "$KEYCHAIN_PATH"

        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        PP_UUID=$(security cms -D -i "$PP_PATH" | grep -A1 UUID | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
        PP_NAME=$(security cms -D -i "$PP_PATH" | grep -A1 Name | head -2 | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
        cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/"${PP_UUID}.mobileprovision"

        echo "PP_UUID=$PP_UUID" >> $GITHUB_ENV
        echo "PP_NAME=$PP_NAME" >> $GITHUB_ENV

        echo "Certificate imported, profile installed"
        echo "  UUID: $PP_UUID"
        echo "  Name: $PP_NAME"
        security find-identity -v -p codesigning "$KEYCHAIN_PATH"

    - name: Configure code signing for App target
      env:
        TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      run: |
        python3 << 'PYEOF'
        import os, re

        project_path = "ios/App/App.xcodeproj/project.pbxproj"
        team_id = os.environ["TEAM_ID"]
        pp_name = os.environ.get("PP_NAME", "")
        pp_uuid = os.environ.get("PP_UUID", "")

        with open(project_path, "r") as f:
            content = f.read()

        # Step 1: Disable automatic signing and set team for App target
        # Find buildSettings blocks that belong to the App target (they contain PRODUCT_BUNDLE_IDENTIFIER)
        lines = content.split('\n')
        new_lines = []
        in_build_settings = False
        brace_depth = 0
        is_app_target = False
        added_signing = False

        for i, line in enumerate(lines):
            new_lines.append(line)

            if 'buildSettings = {' in line:
                in_build_settings = True
                brace_depth = 1
                is_app_target = False
                added_signing = False
                continue

            if in_build_settings:
                if '{' in line:
                    brace_depth += line.count('{')
                if '}' in line:
                    brace_depth -= line.count('}')

                if 'PRODUCT_BUNDLE_IDENTIFIER' in line and 'app.offchat.messenger' in line:
                    is_app_target = True

                if brace_depth == 0:
                    in_build_settings = False

                if is_app_target and not added_signing and 'PRODUCT_NAME' in line:
                    indent = '\t\t\t\t'
                    new_lines.append(f'{indent}CODE_SIGN_IDENTITY = "Apple Distribution";')
                    new_lines.append(f'{indent}CODE_SIGN_STYLE = Manual;')
                    new_lines.append(f'{indent}DEVELOPMENT_TEAM = {team_id};')
                    new_lines.append(f'{indent}"PROVISIONING_PROFILE_SPECIFIER[sdk=iphoneos*]" = "{pp_name}";')
                    added_signing = True

        content = '\n'.join(new_lines)

        # Step 2: Also set ProvisioningStyle to Manual in project-level attributes
        content = content.replace(
            'ProvisioningStyle = Automatic;',
            'ProvisioningStyle = Manual;'
        )

        with open(project_path, "w") as f:
            f.write(content)

        print(f"Code signing configured:")
        print(f"  Team: {team_id}")
        print(f"  Profile: {pp_name}")
        print(f"  UUID: {pp_uuid}")
        PYEOF

    - name: Build iOS archive
      run: |
        xcodebuild -workspace ios/App/App.xcworkspace \
          -scheme App \
          -sdk iphoneos \
          -configuration Release \
          -archivePath $RUNNER_TEMP/Offchat.xcarchive \
          -destination "generic/platform=iOS" \
          clean archive \
          ONLY_ACTIVE_ARCH=NO \
          | tee build.log | tail -50

        if [ ${PIPESTATUS[0]} -ne 0 ]; then
          echo "=== BUILD FAILED ==="
          echo "Last 100 lines of build log:"
          tail -100 build.log
          exit 1
        fi

    - name: Export IPA
      run: |
        cat > $RUNNER_TEMP/ExportOptions.plist << PLIST
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key>
          <string>ad-hoc</string>
          <key>teamID</key>
          <string>${{ secrets.IOS_TEAM_ID }}</string>
          <key>signingStyle</key>
          <string>manual</string>
          <key>provisioningProfiles</key>
          <dict>
            <key>app.offchat.messenger</key>
            <string>${PP_NAME}</string>
          </dict>
          <key>compileBitcode</key>
          <false/>
          <key>stripSwiftSymbols</key>
          <true/>
        </dict>
        </plist>
        PLIST

        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/Offchat.xcarchive \
          -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist \
          -exportPath $RUNNER_TEMP/export \
          -allowProvisioningUpdates

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: offchat-ios-ipa
        path: ${{ runner.temp }}/export/*.ipa
        retention-days: 30

    - name: Clean up keychain
      if: always()
      run: |
        security default-keychain -s login.keychain-db 2>/dev/null || true
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true
