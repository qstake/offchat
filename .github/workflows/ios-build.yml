name: iOS IPA Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build web app
      run: npm run build

    - name: Install Capacitor
      run: npm install @capacitor/core @capacitor/cli @capacitor/ios @capacitor-community/bluetooth-le

    - name: Create Capacitor config
      run: |
        rm -f capacitor.config.ts capacitor.config.json
        cat > capacitor.config.json << 'EOF'
        {
          "appId": "app.offchat.messenger",
          "appName": "Offchat",
          "webDir": "dist/public",
          "server": {
            "androidScheme": "https",
            "allowNavigation": ["offchat.app", "*.offchat.app"]
          },
          "plugins": {
            "CapacitorHttp": {
              "enabled": true
            },
            "StatusBar": {
              "style": "DARK",
              "overlaysWebView": true
            },
            "BluetoothLe": {
              "displayStrings": {
                "scanning": "Searching for Offchat users...",
                "cancel": "Cancel",
                "availableDevices": "Nearby Offchat Users",
                "noDeviceFound": "No Offchat users found nearby"
              }
            }
          }
        }
        EOF

    - name: Add iOS platform
      run: npx cap add ios 2>&1 || true

    - name: Fix Podfile deployment target
      run: sed -i '' "s/platform :ios, '.*'/platform :ios, '16.0'/g" ios/App/Podfile

    - name: Patch existing post_install hook in Podfile
      run: |
        sed -i '' 's/assertDeploymentTarget(installer)/assertDeploymentTarget(installer)\
          installer.pods_project.targets.each do |target|\
            target.build_configurations.each do |config|\
              config.build_settings["CODE_SIGNING_ALLOWED"] = "NO"\
              config.build_settings["CODE_SIGNING_REQUIRED"] = "NO"\
              config.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = "16.0"\
            end\
          end/' ios/App/Podfile
        echo "Podfile updated:"
        cat ios/App/Podfile

    - name: Fix Xcode project deployment target
      run: sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9]*\.[0-9]*/IPHONEOS_DEPLOYMENT_TARGET = 16.0/g' ios/App/App.xcodeproj/project.pbxproj

    - name: Install CocoaPods
      working-directory: ios/App
      run: pod install --repo-update

    - name: Copy web assets
      run: npx cap copy ios

    - name: Add Bluetooth permissions
      run: |
        PLIST="ios/App/App/Info.plist"
        /usr/libexec/PlistBuddy -c "Add :NSBluetoothAlwaysUsageDescription string 'Offchat uses Bluetooth to send messages to nearby users without internet'" "$PLIST" 2>/dev/null || true
        /usr/libexec/PlistBuddy -c "Add :NSBluetoothPeripheralUsageDescription string 'Offchat uses Bluetooth to communicate with nearby devices'" "$PLIST" 2>/dev/null || true
        /usr/libexec/PlistBuddy -c "Add :NSLocalNetworkUsageDescription string 'Offchat uses local network to discover nearby users'" "$PLIST" 2>/dev/null || true

    - name: Set app icon
      run: |
        LOGO="client/public/applogo.png"
        if [ -f "$LOGO" ]; then
          ICONSET="ios/App/App/Assets.xcassets/AppIcon.appiconset"
          if [ -d "$ICONSET" ]; then
            for SIZE in AppIcon-20x20@1x AppIcon-20x20@2x AppIcon-20x20@3x AppIcon-29x29@1x AppIcon-29x29@2x AppIcon-29x29@3x AppIcon-40x40@1x AppIcon-40x40@2x AppIcon-40x40@3x AppIcon-60x60@2x AppIcon-60x60@3x AppIcon-76x76@1x AppIcon-76x76@2x AppIcon-83.5x83.5@2x; do
              cp "$LOGO" "$ICONSET/${SIZE}.png"
            done
            cp "$LOGO" "$ICONSET/AppIcon-512@2x.png" 2>/dev/null || true
          fi
        fi

    - name: Install certificate and provisioning profile
      env:
        P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
        P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        PP_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
      run: |
        CERT_PATH=$RUNNER_TEMP/certificate.p12
        PP_PATH=$RUNNER_TEMP/profile.mobileprovision
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KC_PASSWORD="actions-keychain-password"
        echo -n "$P12_BASE64" | base64 --decode -o "$CERT_PATH"
        echo -n "$PP_BASE64" | base64 --decode -o "$PP_PATH"
        security create-keychain -p "$KC_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KC_PASSWORD" "$KEYCHAIN_PATH"
        security import "$CERT_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
        security set-key-partition-list -S apple-tool:,apple: -k "$KC_PASSWORD" "$KEYCHAIN_PATH"
        security list-keychain -d user -s "$KEYCHAIN_PATH"
        mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
        PLIST_XML=$(security cms -D -i "$PP_PATH")
        PP_UUID=$(echo "$PLIST_XML" | /usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin)
        PP_NAME=$(echo "$PLIST_XML" | /usr/libexec/PlistBuddy -c "Print :Name" /dev/stdin)
        cp "$PP_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/${PP_UUID}.mobileprovision"
        echo "PP_UUID=$PP_UUID" >> $GITHUB_ENV
        echo "PP_NAME=$PP_NAME" >> $GITHUB_ENV
        echo "Profile installed - Name: $PP_NAME, UUID: $PP_UUID"
        security find-identity -v -p codesigning "$KEYCHAIN_PATH"

    - name: Build iOS archive
      run: |
        xcodebuild -workspace ios/App/App.xcworkspace \
          -scheme App \
          -sdk iphoneos \
          -configuration Release \
          -archivePath "$RUNNER_TEMP/Offchat.xcarchive" \
          -destination "generic/platform=iOS" \
          clean archive \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGN_STYLE=Manual \
          "DEVELOPMENT_TEAM=${{ secrets.IOS_TEAM_ID }}" \
          "CODE_SIGN_IDENTITY=Apple Distribution" \
          "PROVISIONING_PROFILE=$PP_UUID"

    - name: Export IPA
      run: |
        echo '<?xml version="1.0" encoding="UTF-8"?>' > "$RUNNER_TEMP/ExportOptions.plist"
        echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '<plist version="1.0">' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '<dict>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '  <key>method</key>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '  <string>ad-hoc</string>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '  <key>teamID</key>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo "  <string>${{ secrets.IOS_TEAM_ID }}</string>" >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '  <key>signingStyle</key>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '  <string>manual</string>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '  <key>provisioningProfiles</key>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '  <dict>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '    <key>app.offchat.messenger</key>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo "    <string>${PP_NAME}</string>" >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '  </dict>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '  <key>compileBitcode</key>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '  <false/>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '  <key>stripSwiftSymbols</key>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '  <true/>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '</dict>' >> "$RUNNER_TEMP/ExportOptions.plist"
        echo '</plist>' >> "$RUNNER_TEMP/ExportOptions.plist"
        xcodebuild -exportArchive \
          -archivePath "$RUNNER_TEMP/Offchat.xcarchive" \
          -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist" \
          -exportPath "$RUNNER_TEMP/export" \
          -allowProvisioningUpdates

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: offchat-ios-ipa
        path: ${{ runner.temp }}/export/*.ipa
        retention-days: 30

    - name: Clean up keychain
      if: always()
      run: |
        security default-keychain -s login.keychain-db 2>/dev/null || true
        security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" 2>/dev/null || true
